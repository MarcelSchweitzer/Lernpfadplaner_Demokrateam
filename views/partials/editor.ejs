
<link rel="stylesheet" href="/css/editor.css">
</link>
<%
// return true if data is available
function canBeRead(root, calls){
    if(calls.length == 1 && root[calls[0]])
        return true
    if(root[calls[0]]){
        let origCalls = calls.slice()
        calls.splice(0, 2, calls[1])
        return canBeRead(root[origCalls[0]], calls)
    }
    return false
}

// create one object with all active Interaction createdTypes

// add all active default Types
var activeTypes = data.learningPath.lpSettings.activeDefaultTypes;

// add all active created interaction Types to the connected categories
for(let [categoryName, interactionTypes] of Object.entries(data.learningPath.lpSettings.createdTypes)){
    // if category is not a default category add the category to activeTypes
    if(!data.learningPath.lpSettings.activeDefaultTypes[categoryName]){
        activeTypes[categoryName] = [];    
    }

    //add every active interaction Type to the connected category
    for (let [interactionTypeName, active] of Object.entries(interactionTypes)){
        if(active){
            activeTypes[categoryName].push(interactionTypeName);
        }
    }
}

// filter out all empty categories
for(let [categoryName, interactionTypes] of Object.entries(activeTypes)){
    if(interactionTypes.length === 0)
        delete activeTypes[categoryName];
}

%>

<div class="container-fluid">
    <div class="cover-background">
        <div class="row">
            <div class="col-2 sidecol">
                <section class="left">
                    <div class="sidepanel sidepanel-first scrollable">
                        <div class="rate-part">
                            <hr>
                            <button class="button btn btn-light overviewBtn" id="hideTreeGraph">
                                <img class="button" id="hideTreeGraph" src="img/diagram-3.svg">
                            </button>
                            <div id="treegraphNav" class="overlay">
                                <a href="javascript:void(0)" class="closebtn" onclick="closeTreegraphOverlay()">&times;</a>
                                <div class="overlay-content">
                                    <div id="treegraph">

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="rate-part">
                            <hr>
                            <div class="note" >
                                <textarea class="form-control lpNotes" id="lpNotes"><%=data.learningPath.notes%></textarea>
                                <div class="noteMaximize">
                                    <a href="#" data-toggle="modal" data-target="#noteModal">
                                        <img class="img-fluid button" src="img/maximize.png">
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="taxonomy-part">
                            <hr>
                            <p>Taxonomiestufe</p>
                            <hr>
                            <form>
                                <div class="form-group col-12">
                                    <select class="form-control" id="lpTaxonomyLevel" selected="<%=data.learningPath.taxonomyLevel%>">
                                        <% if(canBeRead(data, ['taxonomyLevels'])){  data.taxonomyLevels.forEach(taxLev=>{ %>
                                            <option <% if(taxLev == data.learningPath.taxonomyLevel){ %> selected <%}%> > <%= taxLev %> </option>
                                        <% }); } %>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="rate-part">
                            <hr>
                            <p>Bewertungsmodus </p>
                            <hr>
                            <form>
                                <div class="form-group col-12">
                                    <select class="form-control" id="lpEvaluationMode" selected="<%=data.learningPath.evaluationModeID%>">
                                        <% if(canBeRead(data, ['evaluationModes'])){  data.evaluationModes.forEach(evalMode=>{ %>
                                            <option <% if(evalMode == data.learningPath.evaluationModeID){ %> selected <%}%> > <%= evalMode %> </option>
                                        <% }); } %>
                                    </select>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="sidepanel sidepanel-second scrollable">
                        <div class="rate-part">
                            <div class="interactivity">
                                <hr>
                                <p>Interaktivitäten</p>
                                <hr>
                                <div class="interactivityList">
                                    <% if(canBeRead(data, ['learningPath', 'scenarios']) &&
                                            data.learningPath.scenarios.length > 0 &&
                                            canBeRead(data.learningPath.scenarios[data.learningPath.scenarios.length -1 ], ['interactions'])){
                                        let count = 0;
                                    data.learningPath.scenarios[data.learningPath.scenarios.length-1].interactions.forEach(ia=>{ %>
                                    <div class="interactivityListElem">
                                        <button class="btn btn-light interactivityListItem" id="iaListItem<%= count %>">
                                            <%= ia.category.replace("_", " " ) %> -
                                            <%= ia.interactionType.replaceAll("_", " " ) %>
                                        </button>
                                    </div>
                                    <% count++; }); %>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </div>

            <div class="col-8 midCol">
                <div class="material-group scenarios scrollable" id="scenarios">
                    <% if(canBeRead(data, ['learningPath','scenarios'])){
                        let count = 0;
                    data.learningPath.scenarios.forEach(sc=>{
                        let lastScenario = count == data.learningPath.scenarios.length - 1;
                        let showLastscenario = lastScenario ? ' show' : '';
                    %>
                    <div class="card scenario">
                        <div class="card-header" id="heading<%= count %>">
                            <h5 class="mb-0">
                                <div class="scenarioContr">
                                    <input type="text" onSubmit="return false;" class="form-control lpTitleInput scenarioHeaderInput" id="lpTitleInput<%= count %>" value="<%= sc.title %>">
                                    <button class="btn btn-link btn-link openScenario scenarioHeaderInput" data-toggle="collapse" id="openScenario<%= count %>" aria-expanded="<%= lastScenario %>" aria-controls="collapse<%= count %>">
                                        <img <%if(lastScenario){%> src="./img/arrows-collapse.svg" <%} else {%> src="./img/arrows-fullscreen.svg"<%}%>" id="openScenario<%= count %>Img" alt="script" class="script openScenarioImg">
                                    </button>
                                    <div class="accordionWrap scenarioHeaderInput">
                                        <button class="button btn btn-light scenarioBtn printScenario" onSubmit="return false;" id="printScenario<%= count %>">
                                            <img class="button dashIcon scenarioBtnImg printScenario" id="printScenario<%= count %>" src="img/download.svg">
                                        </button>
                                        <button class="button btn btn-light scenarioHeaderInput rightScenarioHBtn delScen" id="delScen<%= count %>">
                                            <img class="button dashIcon delScen" src="img/trash.svg" id="delScen<%= count %>">
                                        </button>
                                    </div>
                                    <!-- delete -->
                                    <div class="modal fade" id="delete<%= count %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header"></div>
                                                <div class="modal-body">
                                                    <!-- "<%= sc.title %>" is only valid at startup, needs to be updated at runtime -->
                                                    <p  class="textInModal">Bist Du sicher? </p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-light deleteScenario" id="deleteScenario<%= count %>" data-dismiss="modal">Löschen</button>
                                                    <button type="button" class="btn btn-light" data-dismiss="modal">Abbrechen</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- delete -->
                                </div>
                            </h5>
                        </div>
                        <div id="collapse<%= count %>" class="collapse<%= showLastscenario %>" aria-labelledby="heading<%= count %>" data-parent="#scenarios">
                            <div class="card-body">
                                <div class="scenarioControllWrapper">
                                    <div class="scenarioControlls scenarioLeftControlls">
                                        <div class="form-group">
                                            <label for="lpDescription<%= count %>">Beschreibung</label>
                                            <textarea class="form-control lpDescription" id="lpDescription<%= count %>"><%= sc.description %></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="lpLearningGoal<%= count %>">Lernziel</label>
                                            <textarea class="form-control lpLearningGoal" id="lpLearningGoal<%= count %>"><%= sc.learningGoal %></textarea>
                                        </div>
                                    </div>
                                    <div class="scenarioControlls scenarioRightControlls">
                                        <div class="note" >
                                            <label for="lpNote<%= count %>">Szenario-Notizen</label>
                                            <textarea class="form-control lpNotes lpNote" id="lpNote<%= count %>"><%=sc.note%></textarea>
                                        </div>
                                    </div>
                                </div>
                                <hr class="rounded">
                                <div>
                                    <label>Arbeitsbereich</label>
                                    <div class="inner-material">
                                        <div class="workspace" id="workspace<%= count %>"></div>
                                    </div>
                                    <div class="scenarioButtonWrap">
                                        <button class="btn btn-light scenarioBtn" onSubmit="return false;" id="resetZoomBtn">
                                            <img class="button dashIcon scenarioBtnImg" id="resetZoomBtn" src="img/aspect-ratio.svg">
                                        </button>
                                        <button class="btn btn-light scenarioBtn" onSubmit="return false;" id="fullScreenBtn">
                                            <img class="button dashIcon scenarioBtnImg" id="fullScreenBtn" src="img/arrows-fullscreen (1).svg">
                                        </button>
                                    </div>
                                </div>
                                <hr class="dotted">
                                <form>
                                    <div class="form-group">
                                        <label for="lpResource<%= count %>">Szenario-URL</label>
                                        <div class="input-group copyBox">
                                            <input type="text" onSubmit="return false;" placeholder="URL" class="form-control lpResource" id="lpResource<%= count %>" value="<%= sc.resource %>">
                                            <!-- <div class="input-group-append">
                                                <button class="btn btn-outline-secondary"  type="button">
                                                    <img src="./img/copy.png" alt="copy to clipbord"/>
                                                </button>
                                              </div> -->
                                        </div>
                                    </div>
                                   
                                </form>
                            </div>
                        </div>
                    </div>
                    <% count++; }); }%>
                    <div class="card scenario">
                        <div class="card-header" id="headingAddScenario">
                            <h5 class="mb-0">
                                <button class="btn btn-link collapsed" id="addScenarioButton" data-toggle="collapse" data-target="#collapseAddScenario" aria-expanded="false" aria-controls="collapseAddScenario">
                                    <h3 id="addScenarioButton">
                                        +
                                    </h3>
                                </button>
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-2 sidecol">
                <section class="right">
                    <div class="sidepanel sidepanel-first scrollable">
                        <div class="rate-part">
                            <hr>
                            <p class="typ">Interaktionstypen</p>
                            <hr>
                            <div class="interactivityPicker">
                                <% if(Object.keys(activeTypes).length !== 0){
                                    let count = 0;
                                    for (let [category, interactionTypes] of Object.entries(activeTypes)){ %>
                                <div class="categoryBox">
                                    <hr>
                                    <h6 class="interactivityCategory">
                                        <% catName = category.replace("_", " " ); %>
                                        <%= catName %>
                                    </h6>
                                    <hr>
                                    <% for (let interactionTypeName of interactionTypes){ %>
                                        <div class="interactivityBox" id="<%= category %>$$<%= interactionTypeName %>" draggable="true">
                                            <p class="selectedInteractivity">
                                                <%= interactionTypeName %>
                                            </p>
                                            <span class="tooltiptext"> <%= interactionTypeName %> </span>
                                        </div>
                                    <% } %>
                                </div>
                                <% }} %>
                            </div>
                        </div>
                    </div>
                </section>
                <div class="sidepanel sidepanel-second scrollable">
                    <div class="rate-part">
                        <hr>
                        <p>Interaktivitätseinstellungen</p>
                        <hr>
                        <div class="interactionSettings">
                            <div class="form-group interactionItem">
                                <label for="hotSpotSize" class="form-label">Hotspot-Größe</label>
                                <input type="range" class="form-range hotSpotSize slider" id="hotSpotSize" min="10" max="250" step="1">
                            </div>
                            <div class="form-group interactionItem">
                                <label class="coords" for="x_coord">X</label>
                                <input type="text" onSubmit="return false;" class="form-control interSet interInp coords x_coord" id="x_coord">
                                <label class="coords" for="y_coord">Y</label>
                                <input type="text" onSubmit="return false;" class="form-control interSet interInp coords y_coord" id="y_coord">
                            </div>
                            <div class="form-group interactionItem">
                               <form class="clipboard">
                                <label for="materialUrl">Material URL</label>
                                <div class="matWrap">
                                    <input type="text" onSubmit="return false;" class="form-control text interSet interInp materialUrl"  id="materialUrl">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary copyBtnMaterialUrl" onSubmit="return false;" id="copyBtnMaterialUrl" type="button">
                                            <img id="copyBtnMaterialUrl" src="./img/copy.png" onSubmit="return false;" alt="copy to clipbord"/>
                                        </button>
                                      </div>
                                </div>
                            </form>
                            </div>
                            <div class="form-group interactionItem">
                                <label for="evaluationHeurestic">Erreichbare Wertung</label>
                                <input type="text" onSubmit="return false;" class="form-control interSet interInp evaluationHeurestic" id="evaluationHeurestic">
                            </div>
                            <div class="form-group interactionItem">
                                <label for="taxonomyLevelInt">Taxonomiestufe</label>
                                <select class="form-control interSet" id="taxonomyLevelInt">
                                    <% if(canBeRead(data, ['taxonomyLevels'])){  data.taxonomyLevels.forEach(taxLev=>{ %>
                                        <option id="<%= taxLev.replaceAll(" ", "_")%>">
                                            <%= taxLev %>
                                        </option>
                                    <% }); } %>
                                </select>
                            </div>
                            <div class="form-group interactionItem">
                                <label for="behaviorSettings">Verhaltenseinstellungen</label>
                                <select class="form-control interSet" id="behaviorSettings">
                                    <%
                                    behaviorModes = [' ', 'Hover', 'Click'];
                                    behaviorModes.forEach(bm=> { %>
                                        <option id="<%= bm %>">
                                            <%= bm %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="form-group interactionItem">
                                <label for="interactionTypeDrop">Interaktionstyp</label>
                                <select class="form-control interSet" id="interactionTypeDrop">
                                    <option id="noInteractiontype" class="changeInteractivity"> </option>
                                    <% if(Object.keys(activeTypes).length !== 0){
                                        let count = 0;
                                            for (let [category, interactionTypes] of Object.entries(activeTypes)){ %>
                                    <optgroup label=<%= category %>>
                                        <% for (let interactionTypeName of interactionTypes){ %>
                                            <option id="$$<%= category %>$$<%= interactionTypeName %>" class="changeInteractivity">
                                                <%= interactionTypeName %>
                                            </option>
                                        <% }}} %>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group interactionItem">
                                <button class="btn btn-light deleteIntBtn interSet" id="delOpenInt">
                                    <img class="button" src="img/trash.svg">
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="noteModalLabel">Notizen</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <textarea class="form-control lpNotesModal" id="lpNotesModal"><%=data.learningPath.notes%></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="taxToHigh" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <p class="HeaderInModal">Warnung</p>
                    </div>
                    <div class="modal-body">
                        <p class="textInModal">Die Taxonomiestufe dieser Interaktivität liegt über der
                            Taxonomiestufe des Lernpfades.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-dismiss="modal">Okay</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="taxToLow" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <p class="HeaderInModal">Warnung</p>
                    </div>
                    <div class="modal-body">
                        <p class="textInModal">Die Taxonomiestufe des Lernpfades liegt unter der
                            Taxonomiestufe einer oder mehrerer Interaktivitäten.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-dismiss="modal">Okay</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="deleteInteract" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header"></div>
                    <div class="modal-body">
                        <p class="textInModal">Bist Du sicher? </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" id="deleteInteractivity" data-dismiss="modal">Löschen</button>
                        <button type="button" class="btn btn-light" data-dismiss="modal">Abbrechen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
   
 
  